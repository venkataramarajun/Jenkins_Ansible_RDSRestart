pipeline {
    agent { label 'docker-build-aws' }

    environment {
        JOB_PARENT_FOLDER = 'GHSSelfServicePlatform'
        JOB_FOLDER = 'AWS-RDS-Restart'
        JOB_TRACKING_FILE = 'created_jobs.log'
        YAML_INPUT_PATH = 'Platform-SelfService/User_Inputs/RestartRDS'
        JENKINS_TOKEN = credentials("pavani_jenkins_api_token")
        PLAYBOOK_REPO_URL = 'https://git.cglcloud.com/IHSCloudPlatform/Maintenance/tree/rds-restart/Playbooks/RDS_Reboot/rds-restart.git'
        PLAYBOOK_PATH = 'Playbooks/RDS_Reboot/rds-restart/rdsrestart.yaml'
    }

    stages {
        // Checkout the repository containing the Ansible playbook
        stage('Checkout Playbook Repo') {
            steps {
                git branch: 'main', url: "${PLAYBOOK_REPO_URL}", credentialsId: 'git_credentials'
                echo "Ansible playbook repository checked out."
            }
        }

        // List YAML files after the repository checkout via SCM in the job configuration
        stage('List YAML Files from SCM') {
            steps {
                echo 'Listing YAML files from the checked-out repository...'
                script {
                    def yamlFiles = findFiles(glob: '**/*.yml')
                    if (yamlFiles.length == 0) {
                        error("No YAML files found to process.")
                    } else {
                        echo "YAML files found: ${yamlFiles.collect { it.path }}"
                        env.YAML_FILES = yamlFiles.collect { it.path }.join(',')
                    }
                }
            }
        }

        // Create the parent folder (GHSSelfServicePlatform) and the AWS-RDS-Restart folder inside it
        stage('Create AWS-RDS-Restart Folder') {
            steps {
                script {
                    jobDsl scriptText: """
                    folder('${JOB_PARENT_FOLDER}/${JOB_FOLDER}') {
                        displayName('AWS RDS Restart Jobs')
                        description('Folder for RDS restart jobs')
                    }
                    """
                    echo "Job folder '${JOB_PARENT_FOLDER}/${JOB_FOLDER}' created or already exists."
                }
            }
        }

        // Create the jobs inside AWS-RDS-Restart folder with Poll SCM as the build trigger
        stage('Create Jobs in AWS-RDS-Restart Folder with Poll SCM') {
            steps {
                script {
                    def yamlFiles = env.YAML_FILES.split(',')
                    def jobNamesCreated = []

                    yamlFiles.each { yamlFile ->
                        echo "Processing ${yamlFile}..."
                        def yamlContent = readYaml file: "${yamlFile}"

                        def db_name = yamlContent.db_name
                        def region = yamlContent.region
                        def schedule = yamlContent.schedule

                        if (!db_name || !region || !schedule) {
                            echo "Skipping ${yamlFile} due to missing required fields (db_name, region, schedule)."
                        } else {
                            echo "Creating job for DB: ${db_name}, Region: ${region}, Schedule: ${schedule}"

                            // Create or update the Jenkins job using Job DSL with Poll SCM schedule
                            jobDsl scriptText: """
                            pipelineJob("${JOB_PARENT_FOLDER}/${JOB_FOLDER}/${db_name}-restart-schedule") {
                                description('Job to restart RDS DB: ${db_name}')
                                triggers {
                                    scm('${schedule}')
                                }
                                definition {
                                    cps {
                                        script('''
                                            pipeline {
                                                agent any
                                                stages {
                                                    stage('Restart RDS DB') {
                                                        steps {
                                                            echo "Restarting RDS DB: ${db_name} in region: ${region}"
                                                            
                                                            checkout([$class: 'GitSCM', branches: [[name: '*/main']],
                                                                userRemoteConfigs: [[url: '${PLAYBOOK_REPO_URL}']],
                                                                credentialsId: 'git_credentials'])

                                                            sh "ansible-playbook ${WORKSPACE}/${PLAYBOOK_PATH} -e db_name=${db_name} -e region=${region}"
                                                        }
                                                    }
                                                }
                                            }
                                        ''')
                                    }
                                }
                            }
                            """
                            jobNamesCreated << "${db_name}-restart-schedule"
                        }
                    }

                    writeFile file: "${JOB_TRACKING_FILE}", text: jobNamesCreated.join('\n')
                    env.CREATED_JOBS = jobNamesCreated.join(',')
                }
            }
        }

        // Delete jobs if their corresponding YAML files are removed
        stage('Delete Jobs if YAML Removed') {
            steps {
                script {
                    def createdJobs = env.CREATED_JOBS.split(',')
                    def previousJobs = readFile("${JOB_TRACKING_FILE}").split('\n').findAll { it }

                    echo "Previous jobs: ${previousJobs}"
                    echo "Created jobs in this run: ${createdJobs}"

                    def jobsToDelete = previousJobs - createdJobs

                    jobsToDelete.each { jobName ->
                        echo "Deleting job: ${jobName} as it no longer exists in YAML files."
                        jobDsl removedJobAction: 'DELETE', scriptText: """
                            pipelineJob('${JOB_PARENT_FOLDER}/${JOB_FOLDER}/${jobName}') {
                                // This job will be deleted
                            }
                        """
                    }
                }
            }
        }
    }
}
